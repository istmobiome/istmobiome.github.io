---
title: "Introduction"
---
 
```{r setup, include=FALSE}
remove(list = ls())
library(dada2); packageVersion("dada2")
library(ShortRead); packageVersion("ShortRead")
library(phyloseq); packageVersion("phyloseq")
library(ggplot2); packageVersion("ggplot2")
library("plyr"); packageVersion("plyr")
library(vegan)
library(scales)
library(grid)
library(reshape2)
library(rstudioapi)
library(knitr)
library(kableExtra)
library(data.table)
library(DT)
library(rmarkdown)
library(pander)
library(formatR)
library(tidyverse)
library(gridExtra)
library(grid)
library(grDevices)
library(svgPanZoom)
library(RCurl)
library(plotly)
library(pairwiseAdonis)
sessionInfo()
set.seed(0199)
```

```{r set_wd, include=FALSE}
knitr::opts_knit$set(root.dir = getwd())
# This will setwd to wherever the .Rmd file is opened.
ptm <- proc.time()
start_time <- Sys.time()
#opts_chunk$set(,cache=TRUE)
#formatR::tidy_app() run this in R to tidy code. How to do it here?
```

```{r mkdirs, include=FALSE, eval=FALSE}
dir.create("DATA/PHYLOSEQ/TABLES/OUTPUT/PS/", recursive = TRUE)
dir.create("DATA/PHYLOSEQ/TABLES/OUTPUT/OTHER/", recursive = TRUE)
dir.create("DATA/PHYLOSEQ/TABLES/OUTPUT/LEfSe/", recursive = TRUE)
dir.create("DATA/PHYLOSEQ/TABLES/OUTPUT/SUPP/", recursive = TRUE)
dir.create("DATA/PHYLOSEQ/FIGURES/OUTPUT/", recursive = TRUE)
dir.create("DATA/PHYLOSEQ/PS_OBJECTS/", recursive = TRUE)
dir.create("DATA/RDS/", recursive = TRUE)
```

***

With this workflow and the raw data, anyone should be able to reproduce the results of this study. Here we will go through the steps of processing raw 16S rRNA marker gene data and then generating phyloseq objects and analyzing data. We will recreate  figures and tables from the paper as well as many additional data products. Here we report both methods and results in plain text and R code. You can choose to show all code or hide the code using the button in the upper right hand corner of the fron page (default is mostly hide). The document represents a **completely reproducible workflow** of our study. Please see the <a href="data_availability.html">Data section</a> for details about obtaining all data and data products from this study.

## Preamble

<style>
div.blue { background-color:#FBDFB4; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">
<font size="4">This document is  **interactive**. You can **sort and scroll** through most of the tables and the **phylogenetic tree is zoomable**. In the upper right hand corner of the front page is a `Code` button. Use this to show or hide all the code in the document (default is hide) as well as download the `.Rmd` file which you can use to extract the code. Data products from the final paper are highlighted in <font size="3" color="red">Red</font>.</font>
</div>
<p></p>

### Definitions & Abbreviations  

* [Amplicon Sequence Variant](https://www.nature.com/articles/ismej2017119){target="_blank"} (**ASV**): Exact sequence variant---analogous to an OTU---but with single nucleotide resolution.  
* Differentially abundant (**DA**) feature: Taxa, ASV, etc. that is disproportionately abundant in a group of samples and statistically different than other groups. 

### Goals of the Study

1. Assess the taxonomic composition of intestinal communities from herbivorous reef fish.  
2. Determine the diversity of these communities and their similarity/dissimilarity.  
3. Identify differentially abundant ASVs across the host species.  
4. Predict the specificity of differentially abundant ASVs.  

***

## Workflow overview

#### <a href="1_field_observations.html">Part 1: Field Observations</a>

Before we proceed with microbial community analysis, we will run some analyses on field-based behavioral assays of the different herbivorous reef fish species.

#### <a href="2_dada2.html">Part 2: DADA2 Workflow</a>

In this first part we go through the process of ...raw reads, error, blah

#### <a href="3_data_prep.html">Part 3: Data Preparation</a>

Next we go through the steps of defining sample groups, creating phyloseq objects, removing unwanted samples, and removing contaminant ASVs. Various parts of this section can easily be modified to perform different analyses. For example, if you were only interested in a specific taxa or group of samples, you could change the code here to create new phyloseq objects.

#### <a href="4_diversity.html">Part 4: Community Composition & Diversity</a>

In the second part, we assess taxonomic composition as well as alpha and beta diversity. Phyloseq offers many options for assessing diversity, including several alpha diversity metrics, additional ordination  and distance methods, and so on. You can play around with these settings to how it affects the results.

#### <a href="5_da_asv.html">Part 5: Differentially Abundant ASVs</a>

We wanted to understand how ASVs partitioned across host species. We also wanted to assess the specificity of each ASV to determine habitat preference. To our knowledge there is no quantitative way to do this. The only attempt we are aware of was [MetaMetaDB](http://mmdb.aori.u-tokyo.ac.jp/){target="_blank"} but it is based on a 454 database and no longer seems to be in active development. So we used an approach based on the work of [Sullam *et. al.*](https://doi.org/10.1111/j.1365-294X.2012.05552.x){target="_blank"}, first identifying differentially abundant ASVs, then searching for closest database hits, and finally using phylogenetic analysis and top hit metadata (isolation source, natural host) to infer habitat preference.

#### <a href="6_synthesis.html">Part 6: Synthesis</a>

In this section we pull together the results from **Part III** and try to make sense of the microbiomes from these herbivorous reef fish. How are ASVs partitioning across host? How similar are these ASVs to sequences from other studies? What can these patterns tell us about host specificity?

> All tables and figures presented below are named as they appeared in the original publication. We also include many additional data productes that were not part of the original publication.  

#### <a href="7_appendices.html">Appendices</a>

Here we provide information on a) other analyses & visualizations, b) tools & resources used in this workflow, c) submitting sequencing data to public archives, and d) specific R package & versions use in this workflow.

***

## Color & graphics

Throughout this workflow we are going to rely on color to help us tell our story. We will use color to delineate host fish species, but more importantly, to delineate microbial taxa. Microbial diversity is pretty vast and it can be difficult to display all of this diversity in a single, static figure. Additionally, many of us have a decreased ability to see color or differences in color. So it is not only important to use relatively few colors but also a color blind friendly palette. For our figures, we generated a palette based on Bang Wong's scheme described in this [paper](http://dx.doi.org/10.1038/nmeth.1618){target="_blank"}. Wong's color scheme uses contrasting colors that can be distinguished by folks with color vision deficiency---roughly 8% of people (mostly males) are color blind. Do want Keanu Reeves to understand your figures or not? 

This scheme is conservative---there are only 7 colors. We added black and grey to give us a little wiggle room. Others have developed [12 and 15 color palette schemes](http://mkweb.bcgsc.ca/colorblind/){target="_blank"}, but be careful---figures with too many colors can inhibit our ability to discern patterns. Our conservative palette forces us to choose carefully when deciding which taxa to target or how many groups to display. Here we will create two palettes---one for microbial taxa with all the colors and another for the five host fish species. The latter is just a subset of the full palette. Here is the code:

```{r define_color_blind_scheme, cache=TRUE}
#Full palette
friend_pal <- c("#009E73", "#D55E00", "#F0E442", "#CC79A7", "#56B4E9",
    "#E69F00", "#0072B2", "#7F7F7F", "#B6DBFF", "#000000")
#Fish palette
samp_pal <- c("#CC79A7", "#0072B2", "#009E73", "#56B4E9", "#E69F00")
```

```{r save_1, include = FALSE, cache=TRUE}
save.image(file = "DATA/RDS/pw_intro_0.rds")
```

***

<p></p>

#### <a href="1_field_observations.html">Continue to Part 1, Field Observations</a>
